console.log('Loading function');

const https = require('https');
const url = require('url');
const slack_url = 'https://hooks.slack.com/services/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';
const slack_req_opts = url.parse(slack_url);
slack_req_opts.method = 'POST';
slack_req_opts.headers = {
    'Content-Type': 'application/json'
};


function writeBeer(weight, previousweight){
    var req = https.request(slack_req_opts, function(res) {
        console.log('status code: ' + res.statusCode);
        if (res.statusCode === 200) {
            console.log('posted to slack');
        }
    });

    var text = "Beer Error";
    var emoji = ":beers:"
    if(weight < previousweight){
        text = "It's BEER time. Come have a beer! ";
    }else if(weight > previousweight){
         text = "Beer has been stocked. Yay!";
    }

    var params = {
        "channel": "#beertest",
        "username": "Beer Fridge",
        "text": text,
        "icon_emoji": emoji
    };
    req.write(JSON.stringify(params));
    req.end();
}

exports.handler = function(event, context) {
    console.log('Received event:', JSON.stringify(event, null, 2));
    writeBeer(event.weight, event.weightprevious);
};
